function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const params = e.parameter;
  
  // Verifica login
  if (params.action === 'checkUser') {
    const usersSheet = sheet.getSheetByName('Usuários') || sheet.insertSheet('Usuários');
    const usersData = usersSheet.getDataRange().getValues();
    
    for (let i = 1; i < usersData.length; i++) {
            // Compara com '===' para garantir correspondência exata de maiúsculas/minúsculas
        if (usersData[i
            ][
                0
            ].toString() === params.username && usersData[i
            ][
                1
            ].toString() === params.password) {
            return ContentService.createTextOutput(JSON.stringify({
                success: true
                })).setMimeType(ContentService.MimeType.JSON);
            }
        }
    
    return ContentService.createTextOutput(JSON.stringify({
        success: false
        })).setMimeType(ContentService.MimeType.JSON);
    }
    // Carrega dados do usuário logado
  const username = params.username;
  if (!username) return ContentService.createTextOutput("Username missing").setMimeType(ContentService.MimeType.TEXT);

  const userSheet = sheet.getSheetByName(username);
  if (!userSheet) {
    return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
    }

  const data = userSheet.getDataRange().getValues();
  const headers = data[
        0
    ];
  const items = [];

  for (let i = 1; i < data.length; i++) {
    const item = {};
    headers.forEach((header, index) => {
      item[header
            ] = data[i
            ][index
            ];
        });
    items.push(item);
    }

  return ContentService.createTextOutput(JSON.stringify(items)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const data = JSON.parse(e.postData.contents);
  const username = data.username;

  if (!username) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Username missing'
        }))
      .setMimeType(ContentService.MimeType.JSON);
    }

  let userSheet = sheet.getSheetByName(username);
  if (!userSheet) {
    userSheet = sheet.insertSheet(username);
    userSheet.appendRow(['Usuário', 'Título', 'Autor', 'Páginas/Episódios', 'Status', 'Avaliação', 'Data', 'Categoria', 'País'
        ]);
    // Congela a primeira linha
    userSheet.setFrozenRows(1);
    }

  const allData = userSheet.getDataRange().getValues();
  const headers = allData[
        0
    ];

  if (data.action === 'add') {
    userSheet.appendRow([
      username,
      data.title,
      data.author || '',
      data.pages || '',
      data.status,
      data.rating || '',
      data.date,
      data.category,
      data.country || ''
        ]);
    }

  if (data.action === 'update') {
    for (let i = 1; i < allData.length; i++) {
      if (allData[i
            ][
                1
            ] === data.oldTitle) {
        userSheet.getRange(i + 1,
                1,
                1,
                9).setValues([
                    [
          username,
          data.title,
          data.author || '',
          data.pages || '',
          data.status,
          data.rating || '',
          data.date,
          data.category,
          data.country || ''
                    ]
                ]);
        break;
            }
        }
    }

  if (data.action === 'delete') {
    for (let i = 1; i < allData.length; i++) {
      if (allData[i
            ][
                1
            ] === data.title) {
        userSheet.deleteRow(i + 1);
        break;
            }
        }
    }

  return ContentService.createTextOutput(JSON.stringify({ success: true
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

async function callGroq(prompt) {
  const apiKey = PropertiesService.getScriptProperties().getProperty('GROQ_API_KEY');
  const url = 'https: //api.groq.com/openai/v1/chat/completions';

  const payload = {
    model: 'llama-3.3-70b-versatile',
    messages: [
            { role: 'system', content: 'Você é a Alice, uma assistente literária mágica. Ajude com registros e sugestões.'
            },
            { role: 'user', content: prompt
            }
        ],
    temperature: 0.7
    };

  const options = {
    method: 'post',
    contentType: 'application/json',
    headers: { Authorization: `Bearer ${apiKey
            }`
        },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
    };

  try {
    const response = UrlFetchApp.fetch(url, options);
    return JSON.parse(response.getContentText());
    } catch (e) {
    return { error: e.toString()
        };
    }
}

function debug() {
  console.log(UrlFetchApp.fetch("https://google.com").getResponseCode());
}

function removerColunaTempoMedio() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();
  
  sheets.forEach(sheet => {
    const headers = sheet.getRange(1,
        1,
        1, sheet.getLastColumn()).getValues()[
            0
        ];
    const index = headers.indexOf('Tempo Médio');
    if (index !== -1) {
      sheet.deleteColumn(index + 1);
      Logger.log(`Coluna removida da aba: ${sheet.getName()
            }`);
        }
    });
}