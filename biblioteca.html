<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo da Alice</title>
    <meta name="description" content="App da princesa Ana Alice para organizar livros e s√©ries">
    <meta name="theme-color" content="#9333ea">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mundo da Alice">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%239333ea'/><text y='.9em' x='50%' text-anchor='middle' font-size='70' fill='white'>üìö</text></svg>">
    
    <link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22Mundo%20da%20Alice%22%2C%22short_name%22%3A%22Mundo%20da%20Alice%22%2C%22description%22%3A%22App%20da%20princesa%20Ana%20Alice%22%2C%22start_url%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ffffff%22%2C%22theme_color%22%3A%22%239333ea%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20512%20512%27%3E%3Crect%20width%3D%27512%27%20height%3D%27512%27%20fill%3D%27%239333ea%27%2F%3E%3Ctext%20y%3D%27.9em%27%20x%3D%2750%25%27%20text-anchor%3D%27middle%27%20font-size%3D%27380%27%20fill%3D%27white%27%3E%F0%9F%93%9A%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen">
    <div id="app"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzYO5iizLJ-i-NKetEqIHTpphjBY4zo-NV4F5DOmbJL8MGbRm2G_O95G1Wk8UUNj2sP/exec';
        
        let currentUser = null;
        let isLoginMode = true;
        let items = [];
        let displayedItems = [];
        let itemsPerPage = 10;
        let currentPage = 1;
        let showForm = false;
        let filter = 'all';
        let searchTerm = '';
        let searchInput = '';
        let editingId = null;
        let showCharts = false;
        let chartPeriod = 'monthly';
        let chartType = 'all';
        let loading = false;
        let sortBy = 'date-desc'; // date-desc, date-asc, title-asc, title-desc, category, status
        let showSortMenu = false;
        let loginData = {
            username: '',
            password: ''
        };
        let formData = {
            title: '',
            author: '',
            pages: '',
            status: 'Quero ler/assistir',
            rating: '',
            date: '',
            category: 'Livro',
            country: '',
            avgTime: ''
        };

        const statusOptions = ['Quero ler/assistir', 'Lido', 'Assistido', 'Desisti'];
        const ratingOptions = ['Maravilhoso üòç', 'Muito bom üòä', 'Bom üôÇ', 'Mais ou menos ü§®', 'Ruim üôÅ', 'P√©ssimo üòí'];
        const categoryOptions = ['Livro', 'S√©rie'];
        const countryOptions = ['Brasil', 'Coreia do Sul', 'China', 'Jap√£o', 'Taiwan', 'Tail√¢ndia', 'Estados Unidos', 'Outro'];

        function checkSavedLogin() {
            const saved = localStorage.getItem('mundoAliceUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                loadData();
            } else {
                renderLogin();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white font-medium`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function handleLogin() {
            if (!loginData.username || !loginData.password) {
                showNotification('Preencha usu√°rio e senha!', 'error');
                return;
            }

            loading = true;
            renderLogin();

            try {
                const response = await fetch(`${API_URL}?action=checkUser&username=${encodeURIComponent(loginData.username)}&password=${encodeURIComponent(loginData.password)}`);
                const result = await response.json();

                if (result.success) {
                    currentUser = { username: loginData.username };
                    localStorage.setItem('mundoAliceUser', JSON.stringify(currentUser));
                    showNotification('‚ú® Login realizado com sucesso!');
                    loadData();
                } else {
                    showNotification('Usu√°rio ou senha incorretos!', 'error');
                    loading = false;
                    renderLogin();
                }
            } catch (error) {
                console.error('Erro no login:', error);
                showNotification('Erro ao fazer login. Tente novamente.', 'error');
                loading = false;
                renderLogin();
            }
        }

        async function handleRegister() {
            if (!loginData.username || !loginData.password) {
                showNotification('Preencha usu√°rio e senha!', 'error');
                return;
            }

            if (loginData.password.length < 4) {
                showNotification('A senha deve ter no m√≠nimo 4 caracteres!', 'error');
                return;
            }

            loading = true;
            renderLogin();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'registerUser',
                        username: loginData.username,
                        password: loginData.password
                    })
                });

                await new Promise(resolve => setTimeout(resolve, 2000));
                
                currentUser = { username: loginData.username };
                localStorage.setItem('mundoAliceUser', JSON.stringify(currentUser));
                showNotification('‚ú® Cadastro realizado com sucesso!');
                loadData();
            } catch (error) {
                console.error('Erro no cadastro:', error);
                showNotification('Erro ao cadastrar. Tente novamente.', 'error');
                loading = false;
                renderLogin();
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('mundoAliceUser');
            items = [];
            loginData = { username: '', password: '' };
            showNotification('Voc√™ saiu da conta!');
            renderLogin();
        }

        function performSearch() {
            searchTerm = searchInput;
            currentPage = 1;
            render();
        }

        function loadMoreItems() {
            const filtered = getFilteredItems();
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            displayedItems = filtered.slice(0, end);
            
            if (end < filtered.length) {
                currentPage++;
            }
        }

        function resetPagination() {
            currentPage = 1;
            displayedItems = [];
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dateStr;
            }
            
            if (dateStr.includes('000Z')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return `${parts[1]}/${parts[2]}`;
                }
            }
            
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e);
            }
            
            return dateStr;
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            
            if (timeStr.match(/^\d{2}:\d{2}:\d{2}$/)) {
                return timeStr;
            }
            
            if (timeStr.includes('T')) {
                timeStr = timeStr.split('T')[1];
            }
            
            if (timeStr.includes('.')) {
                timeStr = timeStr.split('.')[0];
            }
            
            timeStr = timeStr.replace('Z', '');
            
            const parts = timeStr.split(':');
            if (parts.length >= 3) {
                const hh = parts[0].padStart(2, '0');
                const mm = parts[1].padStart(2, '0');
                const ss = parts[2].substring(0, 2).padStart(2, '0');
                return `${hh}:${mm}:${ss}`;
            }
            
            return timeStr;
        }

        async function loadData() {
            if (!currentUser) return;
            
            loading = true;
            render();
            try {
                const response = await fetch(`${API_URL}?username=${encodeURIComponent(currentUser.username)}`);
                const data = await response.json();
                items = data.map((item, index) => ({
                    id: index,
                    title: item['T√≠tulo'] || item.T√≠tulo || '',
                    author: item['Autor'] || item.Autor || '',
                    pages: (item['P√°ginas/Epis√≥dios'] || item['N¬∫ P√°ginas | Epis√≥dios'] || '').toString().replace(' P√°ginas', '').replace(' Epis√≥dios', '').replace(' p√°ginas', '').replace(' epis√≥dios', '').trim(),
                    status: item['Status'] || item.Status || '',
                    rating: item['Avalia√ß√£o'] || item.Avalia√ß√£o || '',
                    date: item['Data'] || item.Data || '',
                    category: item['Categoria'] || item.Categoria || 'Livro',
                    country: item['Pa√≠s'] || item.Pa√≠s || '',
                    avgTime: item['Tempo M√©dio'] || item['Tempo m√©dio'] || ''
                })).filter(item => item.title);
                
                resetPagination();
                loadMoreItems();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showNotification('Erro ao carregar dados do Google Sheets', 'error');
            }
            loading = false;
            render();
        }

        async function saveToSheet(action, data) {
            loading = true;
            render();
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        username: currentUser.username,
                        ...data
                    })
                });
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                await loadData();
                return true;
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showNotification('Erro ao salvar no Google Sheets', 'error');
                loading = false;
                render();
                return false;
            }
        }

        async function handleSubmit() {
            if (!formData.title) {
                showNotification('O t√≠tulo √© obrigat√≥rio!', 'error');
                return;
            }

            let finalDate = formData.date;
            if (formData.date && formData.date.includes('-')) {
                const parts = formData.date.split('-');
                finalDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
            }

            const itemData = {
                title: formData.title,
                author: formData.author,
                pages: formData.pages,
                status: formData.status,
                rating: formData.rating,
                date: finalDate || new Date().toLocaleDateString('pt-BR'),
                category: formData.category,
                country: formData.country,
                avgTime: formData.avgTime
            };

            if (editingId !== null) {
                const oldItem = items[editingId];
                await saveToSheet('update', {
                    oldTitle: oldItem.title,
                    ...itemData
                });
                showNotification('‚ú® Item atualizado com sucesso!');
            } else {
                await saveToSheet('add', itemData);
                showNotification('‚ú® Item adicionado com sucesso!');
            }

            resetForm();
            render();
        }

        async function handleDelete(index) {
            if (confirm('Deseja realmente excluir este item?')) {
                const item = items[index];
                await saveToSheet('delete', { title: item.title });
                showNotification('üóëÔ∏è Item exclu√≠do com sucesso!');
            }
        }

        function handleEdit(index) {
            const item = items[index];
            editingId = index;
            
            let formattedDate = '';
            if (item.date) {
                const parts = item.date.split('/');
                if (parts.length === 3) {
                    formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
            }
            
            formData = {
                title: item.title,
                author: item.author || '',
                pages: item.pages.toString(),
                status: item.status,
                rating: item.rating,
                date: formattedDate,
                category: item.category,
                country: item.country || '',
                avgTime: formatTime(item.avgTime) || ''
            };
            showForm = true;
            render();
        }

        function resetForm() {
            formData = {
                title: '',
                author: '',
                pages: '',
                status: 'Quero ler/assistir',
                rating: '',
                date: '',
                category: 'Livro',
                country: '',
                avgTime: ''
            };
            showForm = false;
            editingId = null;
        }

        function getFilteredItems() {
            let filtered = items.filter(item => {
                const matchesFilter = filter === 'all' || 
                                     (filter === 'books' && item.category === 'Livro') ||
                                     (filter === 'series' && item.category === 'S√©rie');
                const matchesSearch = item.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                     (item.author && item.author.toLowerCase().includes(searchTerm.toLowerCase()));
                return matchesFilter && matchesSearch;
            });

            // Aplicar ordena√ß√£o
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'title-asc':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    case 'date-asc':
                        return compareDates(a.date, b.date);
                    case 'date-desc':
                        return compareDates(b.date, a.date);
                    case 'category':
                        return a.category.localeCompare(b.category);
                    case 'status':
                        const statusOrder = ['Quero ler/assistir', 'Lido', 'Assistido', 'Desisti'];
                        return statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status);
                    case 'rating':
                        const ratingOrder = ['Maravilhoso üòç', 'Muito bom üòä', 'Bom üôÇ', 'Mais ou menos ü§®', 'Ruim üôÅ', 'P√©ssimo üòí'];
                        const aRating = a.rating ? ratingOrder.indexOf(a.rating) : 999;
                        const bRating = b.rating ? ratingOrder.indexOf(b.rating) : 999;
                        return aRating - bRating;
                    default:
                        return 0;
                }
            });

            return filtered;
        }

        function compareDates(dateA, dateB) {
            if (!dateA) return 1;
            if (!dateB) return -1;
            
            const parseDate = (str) => {
                const parts = str.split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                return new Date(0);
            };
            
            return parseDate(dateA) - parseDate(dateB);
        }

        );
        }

        function getStats() {
            return {
                total: items.length,
                books: items.filter(i => i.category === 'Livro').length,
                series: items.filter(i => i.category === 'S√©rie').length,
                completed: items.filter(i => i.status === 'Lido' || i.status === 'Assistido').length
            };
        }

        function getChartData() {
            const filteredItems = items.filter(item => {
                if (chartType === 'books') return item.category === 'Livro';
                if (chartType === 'series') return item.category === 'S√©rie';
                return true;
            }).filter(item => item.status === 'Lido' || item.status === 'Assistido');

            const dataMap = {};

            filteredItems.forEach(item => {
                if (!item.date) return;
                
                const parts = item.date.split('/');
                if (parts.length !== 3) return;
                
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];

                let key;
                if (chartPeriod === 'daily') {
                    key = `${day}/${month}/${year}`;
                } else if (chartPeriod === 'monthly') {
                    key = `${month}/${year}`;
                } else {
                    key = year;
                }

                dataMap[key] = (dataMap[key] || 0) + 1;
            });

            const sortedKeys = Object.keys(dataMap).sort((a, b) => {
                const parseDate = (str) => {
                    const parts = str.split('/');
                    if (chartPeriod === 'daily') {
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    } else if (chartPeriod === 'monthly') {
                        return new Date(parts[1], parts[0] - 1);
                    } else {
                        return new Date(parts[0]);
                    }
                };
                return parseDate(a) - parseDate(b);
            });

            return sortedKeys.map(key => ({
                label: key,
                value: dataMap[key]
            }));
        }

        function renderChart() {
            const data = getChartData();
            if (data.length === 0) {
                return '<div class="text-center text-gray-500 py-12 text-sm">Nenhum dado dispon√≠vel para o per√≠odo selecionado</div>';
            }

            const maxValue = Math.max(...data.map(d => d.value));

            return `
                <div class="space-y-3">
                    ${data.map(item => {
                        const percentage = (item.value / maxValue) * 100;
                        return `
                            <div class="flex items-center gap-2">
                                <div class="w-20 md:w-32 text-xs md:text-sm text-gray-600 text-right flex-shrink-0">${item.label}</div>
                                <div class="flex-1 flex items-center gap-2">
                                    <div class="flex-1 bg-gray-100 rounded-full h-7 md:h-8 relative overflow-hidden">
                                        <div 
                                            class="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full transition-all duration-500 flex items-center justify-end px-2 md:px-3"
                                            style="width: ${percentage}%"
                                        >
                                            <span class="text-white font-bold text-xs md:text-sm">${item.value}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üìö</div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Mundo da Alice</h1>
                            <p class="text-gray-600">App da princesa Ana Alice! ‚ù§Ô∏è</p>
                        </div>

                        <div class="mb-6">
                            <div class="flex gap-2 bg-gray-100 rounded-lg p-1 mb-6">
                                <button
                                    onclick="isLoginMode = true; renderLogin();"
                                    class="flex-1 px-4 py-2 rounded-lg font-medium transition-colors ${isLoginMode ? 'bg-white shadow-sm' : ''}"
                                >
                                    Entrar
                                </button>
                                <button
                                    onclick="isLoginMode = false; renderLogin();"
                                    class="flex-1 px-4 py-2 rounded-lg font-medium transition-colors ${!isLoginMode ? 'bg-white shadow-sm' : ''}"
                                >
                                    Cadastrar
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio</label>
                                    <input
                                        type="text"
                                        value="${loginData.username}"
                                        oninput="loginData.username = this.value;"
                                        placeholder="Digite seu usu√°rio"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                                    <input
                                        type="password"
                                        value="${loginData.password}"
                                        oninput="loginData.password = this.value;"
                                        onkeypress="if(event.key === 'Enter') ${isLoginMode ? 'handleLogin()' : 'handleRegister()'};"
                                        placeholder="Digite sua senha"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>

                                <button
                                    onclick="${isLoginMode ? 'handleLogin()' : 'handleRegister()'};"
                                    class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-medium hover:shadow-lg transition-shadow disabled:opacity-50"
                                    ${loading ? 'disabled' : ''}
                                >
                                    ${loading ? 'Aguarde...' : (isLoginMode ? 'üîê Entrar' : '‚ú® Criar Conta')}
                                </button>
                            </div>
                        </div>

                        ${!isLoginMode ? `
                        <div class="text-center text-sm text-gray-500 mt-4">
                            <p>üí° Escolha um usu√°rio e senha f√°ceis de lembrar!</p>
                            <p class="mt-1">M√≠nimo 4 caracteres na senha.</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function render() {
            if (!currentUser) {
                renderLogin();
                return;
            }

            loadMoreItems();
            const stats = getStats();
            const filteredItems = getFilteredItems();
            const hasMore = displayedItems.length < filteredItems.length;

            document.getElementById('app').innerHTML = `
                <!-- Header -->
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 shadow-lg">
                    <div class="max-w-6xl mx-auto flex justify-between items-center flex-wrap gap-4">
                        <div>
                            <h1 class="text-3xl font-bold mb-2">Mundo da Alice</h1>
                            <p class="text-purple-100">App da princesa Ana Alice! ‚ù§Ô∏è</p>
                            ${loading ? '<p class="text-purple-200 mt-2 flex items-center gap-2"><span class="loading"></span> Carregando...</p>' : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-purple-100 text-sm mb-2">üë§ ${currentUser.username}</p>
                            <button
                                onclick="handleLogout();"
                                class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                            >
                                Sair
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="max-w-6xl mx-auto px-4 mt-6 mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-purple-600">${stats.total}</div>
                            <div class="text-sm text-gray-600">Total</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-blue-600">${stats.books}</div>
                            <div class="text-sm text-gray-600">Livros</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-pink-600">${stats.series}</div>
                            <div class="text-sm text-gray-600">S√©ries</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-green-600">${stats.completed}</div>
                            <div class="text-sm text-gray-600">Conclu√≠dos</div>
                        </div>
                    </div>
                </div>

                <div class="max-w-6xl mx-auto px-4 pb-8">
                    <!-- Controls -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <input
                                    type="text"
                                    id="searchInput"
                                    placeholder="üîç Buscar..."
                                    value="${searchInput}"
                                    onkeypress="if(event.key === 'Enter') performSearch();"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                />
                                <button
                                    onclick="performSearch();"
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors text-sm whitespace-nowrap"
                                >
                                    Buscar
                                </button>
                                ${searchTerm ? `
                                <button
                                    onclick="searchTerm = ''; searchInput = ''; render();"
                                    class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors text-sm"
                                >
                                    ‚úï
                                </button>
                                ` : ''}
                            </div>
                            
                            <div class="flex gap-2 overflow-x-auto pb-2">
                                <button
                                    onclick="filter = 'all'; render();"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${filter === 'all' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700'}"
                                >
                                    Todos
                                </button>
                                <button
                                    onclick="filter = 'books'; render();"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${filter === 'books' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}"
                                >
                                    üìñ Livros
                                </button>
                                <button
                                    onclick="filter = 'series'; render();"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${filter === 'series' ? 'bg-pink-600 text-white' : 'bg-gray-100 text-gray-700'}"
                                >
                                    üì∫ S√©ries
                                </button>
                            </div>

                            <div class="flex gap-2 overflow-x-auto pb-2">
                                <button
                                    onclick="showCharts = !showCharts; render();"
                                    class="flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-4 py-2 rounded-lg font-medium hover:shadow-lg transition-shadow text-sm whitespace-nowrap"
                                    ${loading ? 'disabled' : ''}
                                >
                                    üìä Gr√°ficos
                                </button>
                                <button
                                    onclick="showForm = !showForm; render();"
                                    class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg font-medium hover:shadow-lg transition-shadow text-sm whitespace-nowrap"
                                    ${loading ? 'disabled' : ''}
                                >
                                    ‚ûï Adicionar
                                </button>
                                <button
                                    onclick="loadData();"
                                    class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:shadow-lg transition-shadow text-sm whitespace-nowrap"
                                    ${loading ? 'disabled' : ''}
                                >
                                    üîÑ Atualizar
                                </button>
                                <button
                                    onclick="showSortMenu = !showSortMenu; render();"
                                    class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:shadow-lg transition-shadow text-sm whitespace-nowrap"
                                >
                                    üîΩ Ordenar
                                </button>
                                ${showSortMenu ? `
                                <div class="bg-white border rounded-lg shadow-lg p-2 absolute mt-2 z-50">
                                    <button onclick="sortBy='title-asc'; showSortMenu=false; resetPagination(); render();" class="block w-full text-left px-4 py-2 hover:bg-gray-100">T√≠tulo A‚ÄìZ</button>
                                    <button onclick="sortBy='title-desc'; showSortMenu=false; resetPagination(); render();" class="block w-full text-left px-4 py-2 hover:bg-gray-100">T√≠tulo Z‚ÄìA</button>
                                    <button onclick="sortBy='date-desc'; showSortMenu=false; resetPagination(); render();" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Mais recentes</button>
                                    <button onclick="sortBy='date-asc'; showSortMenu=false; resetPagination(); render();" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Mais antigos</button>
                                    <button onclick="sortBy='category'; showSortMenu=false; resetPagination(); render();" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Categoria</button>
                                    <button onclick="sortBy='status'; showSortMenu=false; resetPagination(); render();" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Status</button>
                                    <button onclick="sortBy='rating'; showSortMenu=false; resetPagination(); render();" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Avalia√ß√£o</button>
                                </div>
                                ` : ''}

                            </div>
                        </div>
                    </div>

                    <!-- Charts Panel -->
                    ${showCharts ? `
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6">
                        <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-800">üìä Estat√≠sticas</h2>
                        
                        <div class="space-y-3">
                            <div class="flex gap-2 bg-gray-100 rounded-lg p-1 overflow-x-auto">
                                <button
                                    onclick="chartPeriod = 'daily'; render();"
                                    class="px-3 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${chartPeriod === 'daily' ? 'bg-white shadow-sm' : ''}"
                                >
                                    Di√°rio
                                </button>
                                <button
                                    onclick="chartPeriod = 'monthly'; render();"
                                    class="px-3 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${chartPeriod === 'monthly' ? 'bg-white shadow-sm' : ''}"
                                >
                                    Mensal
                                </button>
                                <button
                                    onclick="chartPeriod = 'yearly'; render();"
                                    class="px-3 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${chartPeriod === 'yearly' ? 'bg-white shadow-sm' : ''}"
                                >
                                    Anual
                                </button>
                            </div>

                            <div class="flex gap-2 bg-gray-100 rounded-lg p-1 overflow-x-auto">
                                <button
                                    onclick="chartType = 'all'; render();"
                                    class="px-3 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${chartType === 'all' ? 'bg-white shadow-sm' : ''}"
                                >
                                    Todos
                                </button>
                                <button
                                    onclick="chartType = 'books'; render();"
                                    class="px-3 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${chartType === 'books' ? 'bg-white shadow-sm' : ''}"
                                >
                                    üìñ Livros
                                </button>
                                <button
                                    onclick="chartType = 'series'; render();"
                                    class="px-3 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${chartType === 'series' ? 'bg-white shadow-sm' : ''}"
                                >
                                    üì∫ S√©ries
                                </button>
                            </div>
                        </div>

                        <div class="mt-6">
                            ${renderChart()}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Form -->
                    ${showForm ? `
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6">
                        <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-800">
                            ${editingId !== null ? 'Editar Item' : 'Adicionar Novo Item'}
                        </h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                                    <select
                                        onchange="formData.category = this.value; render();"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        ${categoryOptions.map(opt => `<option value="${opt}" ${formData.category === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select
                                        onchange="formData.status = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        ${statusOptions.map(opt => `<option value="${opt}" ${formData.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo *</label>
                                    <input
                                        type="text"
                                        value="${formData.title}"
                                        oninput="formData.title = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>

                                ${formData.category === 'Livro' ? `
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Autor</label>
                                    <input
                                        type="text"
                                        value="${formData.author}"
                                        oninput="formData.author = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>
                                ` : ''}

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        ${formData.category === 'Livro' ? 'P√°ginas' : 'Epis√≥dios'}
                                    </label>
                                    <input
                                        type="number"
                                        value="${formData.pages}"
                                        oninput="formData.pages = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Avalia√ß√£o</label>
                                    <select
                                        onchange="formData.rating = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        <option value="">Selecione...</option>
                                        ${ratingOptions.map(opt => `<option value="${opt}" ${formData.rating === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                                    <input
                                        type="date"
                                        value="${formData.date}"
                                        onchange="formData.date = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>

                                ${formData.category === 'S√©rie' ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pa√≠s</label>
                                    <select
                                        onchange="formData.country = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        <option value="">Selecione...</option>
                                        ${countryOptions.map(opt => `<option value="${opt}" ${formData.country === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tempo M√©dio (hh:mm:ss)</label>
                                    <input
                                        type="text"
                                        value="${formData.avgTime}"
                                        oninput="formData.avgTime = this.value;"
                                        placeholder="01:00:00"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>
                                ` : ''}
                            </div>

                            <div class="flex flex-col sm:flex-row gap-3 pt-4">
                                <button
                                    onclick="handleSubmit();"
                                    class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-medium hover:shadow-lg transition-shadow disabled:opacity-50 text-sm"
                                    ${loading ? 'disabled' : ''}
                                >
                                    ${loading ? 'Salvando...' : (editingId !== null ? 'Atualizar' : 'Adicionar')}
                                </button>
                                <button
                                    onclick="resetForm(); render();"
                                    class="sm:w-auto px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors disabled:opacity-50 text-sm"
                                    ${loading ? 'disabled' : ''}
                                >
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Items List -->
                    <div class="space-y-4">
                        ${loading && items.length === 0 ? `
                        <div class="bg-white rounded-xl shadow-md p-12 text-center">
                            <div class="text-6xl mb-4">‚è≥</div>
                            <p class="text-gray-500 text-lg">Carregando dados do Google Sheets...</p>
                        </div>
                        ` : displayedItems.length === 0 ? `
                        <div class="bg-white rounded-xl shadow-md p-12 text-center">
                            <div class="text-6xl mb-4">${searchTerm ? 'üîç' : 'üìö'}</div>
                            <p class="text-gray-500 text-lg">
                                ${searchTerm ? 'Nenhum resultado encontrado' : 'Nenhum item encontrado'}
                            </p>
                        </div>
                        ` : displayedItems.map((item) => `
                        <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow p-4 md:p-6">
                            <div class="space-y-4">
                                <div class="flex items-start gap-3">
                                    <div class="text-3xl">${item.category === 'Livro' ? 'üìñ' : 'üì∫'}</div>
                                    <div class="flex-1 min-w-0">
                                        <h3 class="text-lg md:text-xl font-bold text-gray-800 break-words">${item.title}</h3>
                                        ${item.author ? `<p class="text-gray-600 mt-1 text-sm">${item.author}</p>` : ''}
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-2 text-xs md:text-sm">
                                    <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full font-medium">
                                        ${item.status}
                                    </span>
                                    ${item.rating ? `
                                    <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full font-medium">
                                        ${item.rating}
                                    </span>
                                    ` : ''}
                                    ${item.date ? `<span class="text-gray-600">üìÖ ${formatDate(item.date)}</span>` : ''}
                                    ${item.pages ? `<span class="text-gray-600">${item.pages} ${item.category === 'Livro' ? 'p√°ginas' : 'epis√≥dios'}</span>` : ''}
                                    ${item.country ? `<span class="text-gray-600">üåç ${item.country}</span>` : ''}
                                    ${item.avgTime ? `<span class="text-gray-600">‚è±Ô∏è ${formatTime(item.avgTime)}</span>` : ''}
                                </div>

                                <div class="flex gap-2 pt-2">
                                    <button
                                        onclick='handleEdit(${item.id})'
                                        class="flex-1 px-4 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors disabled:opacity-50"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        Editar
                                    </button>
                                    <button
                                        onclick="handleDelete(${item.id})"
                                        class="flex-1 px-4 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors disabled:opacity-50"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                        `).join('')}
                        
                        ${hasMore && displayedItems.length > 0 ? `
                        <div class="flex justify-center py-6">
                            <button
                                onclick="render();"
                                class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-3 rounded-lg font-medium hover:shadow-lg transition-shadow"
                            >
                                Carregar mais (${filteredItems.length - displayedItems.length} restantes)
                            </button>
                        </div>
                        ` : ''}
                        
                        ${displayedItems.length > 0 && !hasMore ? `
                        <div class="text-center py-6 text-gray-500 text-sm">
                            Todos os itens foram carregados üìö
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            const input = document.getElementById('searchInput');
            if (input && document.activeElement === input) {
                const cursorPos = input.selectionStart;
                input.value = searchInput;
                input.setSelectionRange(cursorPos, cursorPos);
            } else if (input) {
                input.addEventListener('input', function(e) {
                    searchInput = e.target.value;
                });
            }
        }

        checkSavedLogin();
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (e) => {
                        e.waitUntil(
                            caches.open('biblioteca-v1').then((cache) => {
                                return cache.addAll(['./', './biblioteca.html']);
                            })
                        );
                    });
                    
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(
                            caches.match(e.request).then((response) => {
                                return response || fetch(e.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl).catch(() => {});
            });
        }
    </script>
</body>
</html>
