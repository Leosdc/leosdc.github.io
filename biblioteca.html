<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo da Alice</title>
    <meta name="description" content="App da princesa Ana Alice para organizar livros e s√©ries">
    <meta name="theme-color" content="#9333ea">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mundo da Alice">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen">
    <div id="app"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzYO5iizLJ-i-NKetEqIHTpphjBY4zo-NV4F5DOmbJL8MGbRm2G_O95G1Wk8UUNj2sP/exec';
        
        let currentUser = null;
        let isLoginMode = true;
        let items = [];
        let displayedItems = [];
        let itemsPerPage = 10;
        let currentPage = 1;
        let showForm = false;
        let filter = 'all';
        let searchTerm = '';
        let searchInput = '';
        let editingId = null;
        let showCharts = false;
        let chartPeriod = 'monthly';
        let chartType = 'all';
        let loading = false;
        let sortBy = 'date-desc';
        let loginData = {
            username: '',
            password: ''
        };
        let formData = {
            title: '',
            author: '',
            pages: '',
            status: 'Quero ler/assistir',
            rating: '',
            date: '',
            category: 'Livro',
            country: '',
            avgTime: ''
        };

        const statusOptions = ['Quero ler/assistir', 'Lido', 'Assistido', 'Desisti'];
        const ratingOptions = ['Maravilhoso üòç', 'Muito bom üòä', 'Bom üôÇ', 'Mais ou menos ü§®', 'Ruim üôÅ', 'P√©ssimo üòí'];
        const categoryOptions = ['Livro', 'S√©rie'];
        const countryOptions = ['Brasil', 'Coreia do Sul', 'China', 'Jap√£o', 'Taiwan', 'Tail√¢ndia', 'Estados Unidos', 'Outro'];

        function checkSavedLogin() {
            const saved = localStorage.getItem('mundoAliceUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                loadData();
            } else {
                renderLogin();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white font-medium`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function handleLogin() {
            if (!loginData.username || !loginData.password) {
                showNotification('Preencha usu√°rio e senha!', 'error');
                return;
            }

            loading = true;
            renderLogin();

            try {
                const response = await fetch(`${API_URL}?action=checkUser&username=${encodeURIComponent(loginData.username)}&password=${encodeURIComponent(loginData.password)}`);
                const result = await response.json();

                if (result.success) {
                    currentUser = { username: loginData.username };
                    localStorage.setItem('mundoAliceUser', JSON.stringify(currentUser));
                    showNotification('‚ú® Login realizado com sucesso!');
                    loadData();
                } else {
                    showNotification('Usu√°rio ou senha incorretos!', 'error');
                    loading = false;
                    renderLogin();
                }
            } catch (error) {
                console.error('Erro no login:', error);
                showNotification('Erro ao fazer login. Tente novamente.', 'error');
                loading = false;
                renderLogin();
            }
        }

        async function handleRegister() {
            if (!loginData.username || !loginData.password) {
                showNotification('Preencha usu√°rio e senha!', 'error');
                return;
            }

            if (loginData.password.length < 4) {
                showNotification('A senha deve ter no m√≠nimo 4 caracteres!', 'error');
                return;
            }

            loading = true;
            renderLogin();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'registerUser',
                        username: loginData.username,
                        password: loginData.password
                    })
                });

                await new Promise(resolve => setTimeout(resolve, 2000));
                
                currentUser = { username: loginData.username };
                localStorage.setItem('mundoAliceUser', JSON.stringify(currentUser));
                showNotification('‚ú® Cadastro realizado com sucesso!');
                loadData();
            } catch (error) {
                console.error('Erro no cadastro:', error);
                showNotification('Erro ao cadastrar. Tente novamente.', 'error');
                loading = false;
                renderLogin();
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('mundoAliceUser');
            items = [];
            loginData = { username: '', password: '' };
            showNotification('Voc√™ saiu da conta!');
            renderLogin();
        }

        function performSearch() {
            searchTerm = searchInput;
            currentPage = 1;
            render();
        }

        function loadMoreItems() {
            const filtered = getFilteredItems();
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            displayedItems = filtered.slice(0, end);
            
            if (end < filtered.length) {
                currentPage++;
            }
        }

        function resetPagination() {
            currentPage = 1;
            displayedItems = [];
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dateStr;
            }
            
            if (dateStr.includes('000Z')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return `${parts[1]}/${parts[2]}`;
                }
            }
            
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e);
            }
            
            return dateStr;
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            
            if (timeStr.match(/^\d{2}:\d{2}:\d{2}$/)) {
                return timeStr;
            }
            
            if (timeStr.includes('T')) {
                timeStr = timeStr.split('T')[1];
            }
            
            if (timeStr.includes('.')) {
                timeStr = timeStr.split('.')[0];
            }
            
            timeStr = timeStr.replace('Z', '');
            
            const parts = timeStr.split(':');
            if (parts.length >= 3) {
                const hh = parts[0].padStart(2, '0');
                const mm = parts[1].padStart(2, '0');
                const ss = parts[2].substring(0, 2).padStart(2, '0');
                return `${hh}:${mm}:${ss}`;
            }
            
            return timeStr;
        }

        async function loadData() {
            if (!currentUser) return;
            
            loading = true;
            render();
            try {
                const response = await fetch(`${API_URL}?username=${encodeURIComponent(currentUser.username)}`);
                const data = await response.json();
                items = data.map((item, index) => ({
                    id: index,
                    title: item['T√≠tulo'] || item.T√≠tulo || '',
                    author: item['Autor'] || item.Autor || '',
                    pages: (item['P√°ginas/Epis√≥dios'] || item['N¬∫ P√°ginas | Epis√≥dios'] || '').toString().replace(' P√°ginas', '').replace(' Epis√≥dios', '').replace(' p√°ginas', '').replace(' epis√≥dios', '').trim(),
                    status: item['Status'] || item.Status || '',
                    rating: item['Avalia√ß√£o'] || item.Avalia√ß√£o || '',
                    date: item['Data'] || item.Data || '',
                    category: item['Categoria'] || item.Categoria || 'Livro',
                    country: item['Pa√≠s'] || item.Pa√≠s || '',
                    avgTime: item['Tempo M√©dio'] || item['Tempo m√©dio'] || ''
                })).filter(item => item.title);
                
                resetPagination();
                loadMoreItems();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showNotification('Erro ao carregar dados do Google Sheets', 'error');
            }
            loading = false;
            render();
        }

        async function saveToSheet(action, data) {
            loading = true;
            render();
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        username: currentUser.username,
                        ...data
                    })
                });
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                await loadData();
                return true;
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showNotification('Erro ao salvar no Google Sheets', 'error');
                loading = false;
                render();
                return false;
            }
        }

        async function handleSubmit() {
            if (!formData.title) {
                showNotification('O t√≠tulo √© obrigat√≥rio!', 'error');
                return;
            }

            let finalDate = formData.date;
            if (formData.date && formData.date.includes('-')) {
                const parts = formData.date.split('-');
                finalDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
            }

            const itemData = {
                title: formData.title,
                author: formData.author,
                pages: formData.pages,
                status: formData.status,
                rating: formData.rating,
                date: finalDate || new Date().toLocaleDateString('pt-BR'),
                category: formData.category,
                country: formData.country,
                avgTime: formData.avgTime
            };

            if (editingId !== null) {
                const oldItem = items[editingId];
                await saveToSheet('update', {
                    oldTitle: oldItem.title,
                    ...itemData
                });
                showNotification('‚ú® Item atualizado com sucesso!');
            } else {
                await saveToSheet('add', itemData);
                showNotification('‚ú® Item adicionado com sucesso!');
            }

            resetForm();
            render();
        }

        async function handleDelete(index) {
            if (confirm('Deseja realmente excluir este item?')) {
                const item = items[index];
                await saveToSheet('delete', { title: item.title });
                showNotification('üóëÔ∏è Item exclu√≠do com sucesso!');
            }
        }

        function handleEdit(index) {
            const item = items[index];
            editingId = index;
            
            let formattedDate = '';
            if (item.date) {
                const parts = item.date.split('/');
                if (parts.length === 3) {
                    formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
            }
            
            formData = {
                title: item.title,
                author: item.author || '',
                pages: item.pages.toString(),
                status: item.status,
                rating: item.rating,
                date: formattedDate,
                category: item.category,
                country: item.country || '',
                avgTime: formatTime(item.avgTime) || ''
            };
            showForm = true;
            render();
        }

        function resetForm() {
            formData = {
                title: '',
                author: '',
                pages: '',
                status: 'Quero ler/assistir',
                rating: '',
                date: '',
                category: 'Livro',
                country: '',
                avgTime: ''
            };
            showForm = false;
            editingId = null;
        }

        function compareDates(dateA, dateB) {
            if (!dateA) return 1;
            if (!dateB) return -1;
            
            const parseDate = (str) => {
                const parts = str.split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                return new Date(0);
            };
            
            return parseDate(dateA) - parseDate(dateB);
        }

        function getFilteredItems() {
            let filtered = items.filter(item => {
                const matchesFilter = filter === 'all' || 
                                     (filter === 'books' && item.category === 'Livro') ||
                                     (filter === 'series' && item.category === 'S√©rie');
                const matchesSearch = item.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                     (item.author && item.author.toLowerCase().includes(searchTerm.toLowerCase()));
                return matchesFilter && matchesSearch;
            });

            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'title-asc':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    case 'date-asc':
                        return compareDates(a.date, b.date);
                    case 'date-desc':
                        return compareDates(b.date, a.date);
                    case 'category':
                        return a.category.localeCompare(b.category);
                    case 'status':
                        const statusOrder = ['Quero ler/assistir', 'Lido', 'Assistido', 'Desisti'];
                        return statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status);
                    case 'rating':
                        const ratingOrder = ['Maravilhoso üòç', 'Muito bom üòä', 'Bom üôÇ', 'Mais ou menos ü§®', 'Ruim üôÅ', 'P√©ssimo üòí'];
                        const aRating = a.rating ? ratingOrder.indexOf(a.rating) : 999;
                        const bRating = b.rating ? ratingOrder.indexOf(b.rating) : 999;
                        return aRating - bRating;
                    default:
                        return 0;
                }
            });

            return filtered;
        }

        function getStats() {
            return {
                total: items.length,
                books: items.filter(i => i.category === 'Livro').length,
                series: items.filter(i => i.category === 'S√©rie').length,
                completed: items.filter(i => i.status === 'Lido' || i.status === 'Assistido').length
            };
        }

        function getChartData() {
            const filteredItems = items.filter(item => {
                if (chartType === 'books') return item.category === 'Livro';
                if (chartType === 'series') return item.category === 'S√©rie';
                return true;
            }).filter(item => item.status === 'Lido' || item.status === 'Assistido');

            const dataMap = {};

            filteredItems.forEach(item => {
                if (!item.date) return;
                
                const parts = item.date.split('/');
                if (parts.length !== 3) return;
                
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];

                let key;
                if (chartPeriod === 'daily') {
                    key = `${day}/${month}/${year}`;
                } else if (chartPeriod === 'monthly') {
                    key = `${month}/${year}`;
                } else {
                    key = year;
                }

                dataMap[key] = (dataMap[key] || 0) + 1;
            });

            const sortedKeys = Object.keys(dataMap).sort((a, b) => {
                const parseDate = (str) => {
                    const parts = str.split('/');
                    if (chartPeriod === 'daily') {
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    } else if (chartPeriod === 'monthly') {
                        return new Date(parts[1], parts[0] - 1);
                    } else {
                        return new Date(parts[0]);
                    }
                };
                return parseDate(a) - parseDate(b);
            });

            return sortedKeys.map(key => ({
                label: key,
                value: dataMap[key]
            }));
        }

        function renderChart() {
            const data = getChartData();
            if (data.length === 0) {
                return '<div class="text-center text-gray-500 py-12 text-sm">Nenhum dado dispon√≠vel para o per√≠odo selecionado</div>';
            }

            const maxValue = Math.max(...data.map(d => d.value));

            return `
                <div class="space-y-3">
                    ${data.map(item => {
                        const percentage = (item.value / maxValue) * 100;
                        return `
                            <div class="flex items-center gap-2">
                                <div class="w-20 md:w-32 text-xs md:text-sm text-gray-600 text-right flex-shrink-0">${item.label}</div>
                                <div class="flex-1 flex items-center gap-2">
                                    <div class="flex-1 bg-gray-100 rounded-full h-7 md:h-8 relative overflow-hidden">
                                        <div 
                                            class="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full transition-all duration-500 flex items-center justify-end px-2 md:px-3"
                                            style="width: ${percentage}%"
                                        >
                                            <span class="text-white font-bold text-xs md:text-sm">${item.value}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üìö</div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Mundo da Alice</h1>
                            <p class="text-gray-600">App da princesa Ana Alice! ‚ù§Ô∏è</p>
                        </div>

                        <div class="mb-6">
                            <div class="flex gap-2 bg-gray-100 rounded-lg p-1 mb-6">
                                <button
                                    onclick="isLoginMode = true; renderLogin();"
                                    class="flex-1 px-4 py-2 rounded-lg font-medium transition-colors ${isLoginMode ? 'bg-white shadow-sm' : ''}"
                                >
                                    Entrar
                                </button>
                                <button
                                    onclick="isLoginMode = false; renderLogin();"
                                    class="flex-1 px-4 py-2 rounded-lg font-medium transition-colors ${!isLoginMode ? 'bg-white shadow-sm' : ''}"
                                >
                                    Cadastrar
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio</label>
                                    <input
                                        type="text"
                                        value="${loginData.username}"
                                        oninput="loginData.username = this.value;"
                                        placeholder="Digite seu usu√°rio"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                                    <input
                                        type="password"
                                        value="${loginData.password}"
                                        oninput="loginData.password = this.value;"
                                        onkeypress="if(event.key === 'Enter') ${isLoginMode ? 'handleLogin()' : 'handleRegister()'};"
                                        placeholder="Digite sua senha"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>

                                <button
                                    onclick="${isLoginMode ? 'handleLogin()' : 'handleRegister()'};"
                                    class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-medium hover:shadow-lg transition-shadow disabled:opacity-50"
                                    ${loading ? 'disabled' : ''}
                                >
                                    ${loading ? 'Aguarde...' : (isLoginMode ? 'üîê Entrar' : '‚ú® Criar Conta')}
                                </button>
                            </div>
                        </div>

                        ${!isLoginMode ? `
                        <div class="text-center text-sm text-gray-500 mt-4">
                            <p>üí° Escolha um usu√°rio e senha f√°ceis de lembrar!</p>
                            <p class="mt-1">M√≠nimo 4 caracteres na senha.</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function render() {
            if (!currentUser) {
                renderLogin();
                return;
            }

            loadMoreItems();
            const stats = getStats();
            const filteredItems = getFilteredItems();
            const hasMore = displayedItems.length < filteredItems.length;

            document.getElementById('app').innerHTML = `
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 shadow-lg">
                    <div class="max-w-6xl mx-auto flex justify-between items-center flex-wrap gap-4">
                        <div>
                            <h1 class="text-3xl font-bold mb-2">Mundo da Alice</h1>
                            <p class="text-purple-100">App da princesa Ana Alice! ‚ù§Ô∏è</p>
                            ${loading ? '<p class="text-purple-200 mt-2 flex items-center gap-2"><span class="loading"></span> Carregando...</p>' : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-purple-100 text-sm mb-2">üë§ ${currentUser.username}</p>
                            <button
                                onclick="handleLogout();"
                                class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                            >
                                Sair
                            </button>
                        </div>
                    </div>
                </div>

                <div class="max-w-6xl mx-auto px-4 mt-6 mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-purple-600">${stats.total}</div>
                            <div class="text-sm text-gray-600">Total</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-blue-600">${stats.books}</div>
                            <div class="text-sm text-gray-600">Livros</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-pink-600">${stats.series}</div>
                            <div class="text-sm text-gray-600">S√©ries</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-green-600">${stats.completed}</div>
                            <div class="text-sm text-gray-600">Conclu√≠dos</div>
                        </div>
                    </div>
                </div>

                <div class="max-w-6xl mx-auto px-4 pb-8">
                    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <input
                                    type="text"
                                    id="searchInput"
                                    placeholder="üîç Buscar..."
                                    value="${searchInput}"
                                    onkeypress="if(event.key === 'Enter') performSearch();"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                                />
                                <button
                                    onclick="performSearch();"
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors text-sm whitespace-nowrap"
                                >
                                    Buscar
                                </button>
                                ${searchTerm ? `
                                <button
                                    onclick="searchTerm = ''; searchInput = ''; resetPagination(); render();"
                                    class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors text-sm"
                                >
                                    ‚úï
                                </button>
                                ` : ''}
                            </div>
                            
                            <div class="flex gap-2 overflow-x-auto pb-2">
                                <button
                                    onclick="filter = 'all'; resetPagination(); render();"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${filter === 'all' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700'}"
                                >
                                    Todos
                                </button>
                                <button
                                    onclick="filter = 'books'; resetPagination(); render();"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${filter === 'books' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}"
                                >
                                    üìñ Livros
                                </button>
                                <button
                                    onclick="filter = 'series'; resetPagination(); render();"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${filter === 'series' ? 'bg-pink-600 text-white' : 'bg-gray-100 text-gray-700'}"
                                >
                                    üì∫ S√©ries
                                </button>
