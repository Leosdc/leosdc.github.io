<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö Minha Biblioteca</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen">
    <div id="app"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzYO5iizLJ-i-NKetEqIHTpphjBY4zo-NV4F5DOmbJL8MGbRm2G_O95G1Wk8UUNj2sP/exec';
        
        let items = [];
        let showForm = false;
        let filter = 'all';
        let searchTerm = '';
        let searchInput = '';
        let editingId = null;
        let loading = false;
        let formData = {
            title: '',
            author: '',
            pages: '',
            status: 'Quero ler/assistir',
            rating: '',
            date: '',
            category: 'Livro',
            country: '',
            avgTime: ''
        };

        const statusOptions = ['Quero ler/assistir', 'Lido', 'Assistido', 'Desisti'];
        const ratingOptions = ['Maravilhoso üòç', 'Muito bom üòä', 'Bom üôÇ', 'Mais ou menos ü§®', 'Ruim üôÅ', 'P√©ssimo üòí'];
        const categoryOptions = ['Livro', 'S√©rie'];
        const countryOptions = ['Brasil', 'Coreia do Sul', 'China', 'Jap√£o', 'Taiwan', 'Tail√¢ndia', 'Estados Unidos', 'Outro'];

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white font-medium`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function performSearch() {
            searchTerm = searchInput;
            render();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            // Se j√° est√° no formato dd/mm/yyyy, retorna
            if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dateStr;
            }
            
            // Remove a parte de timezone se existir (ex: "000Z/12/2025")
            if (dateStr.includes('000Z')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // Pega apenas a parte da data dd/mm/yyyy
                    return `${parts[1]}/${parts[2]}`;
                }
            }
            
            // Tenta converter de timestamp ISO
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e);
            }
            
            return dateStr;
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            
            // Se j√° est√° no formato hh:mm:ss, retorna
            if (timeStr.match(/^\d{2}:\d{2}:\d{2}$/)) {
                return timeStr;
            }
            
            // Remove tudo antes de "T" se for ISO timestamp
            if (timeStr.includes('T')) {
                timeStr = timeStr.split('T')[1];
            }
            
            // Remove a parte ".000Z" se existir
            if (timeStr.includes('.')) {
                timeStr = timeStr.split('.')[0];
            }
            
            // Remove "Z" no final se existir
            timeStr = timeStr.replace('Z', '');
            
            // Pega apenas HH:MM:SS
            const parts = timeStr.split(':');
            if (parts.length >= 3) {
                const hh = parts[0].padStart(2, '0');
                const mm = parts[1].padStart(2, '0');
                const ss = parts[2].substring(0, 2).padStart(2, '0');
                return `${hh}:${mm}:${ss}`;
            }
            
            return timeStr;
        }

        async function loadData() {
            loading = true;
            render();
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                items = data.map((item, index) => ({
                    id: index,
                    title: item['T√≠tulo'] || item.T√≠tulo || '',
                    author: item['Autor'] || item.Autor || '',
                    pages: item['P√°ginas/Epis√≥dios'] || item['N¬∫ P√°ginas | Epis√≥dios'] || '',
                    status: item['Status'] || item.Status || '',
                    rating: item['Avalia√ß√£o'] || item.Avalia√ß√£o || '',
                    date: item['Data'] || item.Data || '',
                    category: item['Categoria'] || item.Categoria || 'Livro',
                    country: item['Pa√≠s'] || item.Pa√≠s || '',
                    avgTime: item['Tempo M√©dio'] || item['Tempo m√©dio'] || '',
                    rawDate: item['Data'] || item.Data || '',
                    rawAvgTime: item['Tempo M√©dio'] || item['Tempo m√©dio'] || ''
                })).filter(item => item.title);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showNotification('Erro ao carregar dados do Google Sheets', 'error');
            }
            loading = false;
            render();
        }

        async function saveToSheet(action, data) {
            loading = true;
            render();
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        ...data
                    })
                });
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                await loadData();
                return true;
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showNotification('Erro ao salvar no Google Sheets', 'error');
                loading = false;
                render();
                return false;
            }
        }

        async function handleSubmit() {
            if (!formData.title) {
                showNotification('O t√≠tulo √© obrigat√≥rio!', 'error');
                return;
            }

            // Converte a data de yyyy-mm-dd para dd/mm/yyyy
            let finalDate = formData.date;
            if (formData.date && formData.date.includes('-')) {
                const parts = formData.date.split('-');
                finalDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
            }

            const itemData = {
                title: formData.title,
                author: formData.author,
                pages: formData.pages,
                status: formData.status,
                rating: formData.rating,
                date: finalDate || new Date().toLocaleDateString('pt-BR'),
                category: formData.category,
                country: formData.country,
                avgTime: formData.avgTime
            };

            if (editingId !== null) {
                const oldItem = items[editingId];
                await saveToSheet('update', {
                    oldTitle: oldItem.title,
                    ...itemData
                });
                showNotification('‚ú® Item atualizado com sucesso!');
            } else {
                await saveToSheet('add', itemData);
                showNotification('‚ú® Item adicionado com sucesso!');
            }

            resetForm();
            render();
        }

        async function handleDelete(index) {
            if (confirm('Deseja realmente excluir este item?')) {
                const item = items[index];
                await saveToSheet('delete', { title: item.title });
                showNotification('üóëÔ∏è Item exclu√≠do com sucesso!');
            }
        }

        function handleEdit(index) {
            const item = items[index];
            editingId = index;
            
            // Formata a data para o campo de input
            let formattedDate = '';
            if (item.date) {
                const parts = item.date.split('/');
                if (parts.length === 3) {
                    formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
            }
            
            formData = {
                title: item.title,
                author: item.author || '',
                pages: item.pages.toString().replace(' P√°ginas', '').replace(' Epis√≥dios', ''),
                status: item.status,
                rating: item.rating,
                date: formattedDate,
                category: item.category,
                country: item.country || '',
                avgTime: formatTime(item.avgTime) || ''
            };
            showForm = true;
            render();
        }

        function resetForm() {
            formData = {
                title: '',
                author: '',
                pages: '',
                status: 'Quero ler/assistir',
                rating: '',
                date: '',
                category: 'Livro',
                country: '',
                avgTime: ''
            };
            showForm = false;
            editingId = null;
        }

        function getFilteredItems() {
            return items.filter(item => {
                const matchesFilter = filter === 'all' || 
                                     (filter === 'books' && item.category === 'Livro') ||
                                     (filter === 'series' && item.category === 'S√©rie');
                const matchesSearch = item.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                     (item.author && item.author.toLowerCase().includes(searchTerm.toLowerCase()));
                return matchesFilter && matchesSearch;
            });
        }

        function getStats() {
            return {
                total: items.length,
                books: items.filter(i => i.category === 'Livro').length,
                series: items.filter(i => i.category === 'S√©rie').length,
                completed: items.filter(i => i.status === 'Lido' || i.status === 'Assistido').length
            };
        }

        function render() {
            const stats = getStats();
            const filteredItems = getFilteredItems();

            document.getElementById('app').innerHTML = `
                <!-- Header -->
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 shadow-lg">
                    <div class="max-w-6xl mx-auto">
                        <h1 class="text-3xl font-bold mb-2">üìö Minha Biblioteca</h1>
                        <p class="text-purple-100">App da princesa Ana Alice! ‚ù§Ô∏è</p>
                        ${loading ? '<p class="text-purple-200 mt-2 flex items-center gap-2"><span class="loading"></span> Carregando...</p>' : ''}
                    </div>
                </div>

                <!-- Stats -->
                <div class="max-w-6xl mx-auto px-4 mt-6 mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-purple-600">${stats.total}</div>
                            <div class="text-sm text-gray-600">Total</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-blue-600">${stats.books}</div>
                            <div class="text-sm text-gray-600">Livros</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-pink-600">${stats.series}</div>
                            <div class="text-sm text-gray-600">S√©ries</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <div class="text-2xl font-bold text-green-600">${stats.completed}</div>
                            <div class="text-sm text-gray-600">Conclu√≠dos</div>
                        </div>
                    </div>
                </div>

                <div class="max-w-6xl mx-auto px-4 pb-8">
                    <!-- Controls -->
                    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 flex gap-2">
                                <input
                                    type="text"
                                    id="searchInput"
                                    placeholder="üîç Buscar t√≠tulo ou autor..."
                                    value="${searchInput}"
                                    onkeypress="if(event.key === 'Enter') performSearch();"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                />
                                <button
                                    onclick="performSearch();"
                                    class="px-6 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors"
                                >
                                    Buscar
                                </button>
                                ${searchTerm ? `
                                <button
                                    onclick="searchTerm = ''; searchInput = ''; render();"
                                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors"
                                >
                                    ‚úï
                                </button>
                                ` : ''}
                            </div>
                            
                            <div class="flex gap-2 flex-wrap">
                                <button
                                    onclick="filter = 'all'; render();"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${filter === 'all' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700'}"
                                >
                                    Todos
                                </button>
                                <button
                                    onclick="filter = 'books'; render();"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${filter === 'books' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}"
                                >
                                    üìñ Livros
                                </button>
                                <button
                                    onclick="filter = 'series'; render();"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${filter === 'series' ? 'bg-pink-600 text-white' : 'bg-gray-100 text-gray-700'}"
                                >
                                    üì∫ S√©ries
                                </button>
                                <button
                                    onclick="showForm = !showForm; render();"
                                    class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-shadow"
                                    ${loading ? 'disabled' : ''}
                                >
                                    ‚ûï Adicionar
                                </button>
                                <button
                                    onclick="loadData();"
                                    class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-shadow"
                                    ${loading ? 'disabled' : ''}
                                >
                                    üîÑ Atualizar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Form -->
                    ${showForm ? `
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">
                            ${editingId !== null ? 'Editar Item' : 'Adicionar Novo Item'}
                        </h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                                    <select
                                        onchange="formData.category = this.value; render();"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        ${categoryOptions.map(opt => `<option value="${opt}" ${formData.category === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select
                                        onchange="formData.status = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        ${statusOptions.map(opt => `<option value="${opt}" ${formData.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo *</label>
                                    <input
                                        type="text"
                                        value="${formData.title}"
                                        oninput="formData.title = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>

                                ${formData.category === 'Livro' ? `
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Autor</label>
                                    <input
                                        type="text"
                                        value="${formData.author}"
                                        oninput="formData.author = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>
                                ` : ''}

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        ${formData.category === 'Livro' ? 'P√°ginas' : 'Epis√≥dios'}
                                    </label>
                                    <input
                                        type="number"
                                        value="${formData.pages}"
                                        oninput="formData.pages = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Avalia√ß√£o</label>
                                    <select
                                        onchange="formData.rating = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        <option value="">Selecione...</option>
                                        ${ratingOptions.map(opt => `<option value="${opt}" ${formData.rating === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                                    <input
                                        type="date"
                                        value="${formData.date}"
                                        onchange="formData.date = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>

                                ${formData.category === 'S√©rie' ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pa√≠s</label>
                                    <select
                                        onchange="formData.country = this.value;"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        <option value="">Selecione...</option>
                                        ${countryOptions.map(opt => `<option value="${opt}" ${formData.country === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tempo M√©dio (hh:mm:ss)</label>
                                    <input
                                        type="text"
                                        value="${formData.avgTime}"
                                        oninput="formData.avgTime = this.value;"
                                        placeholder="01:00:00"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        ${loading ? 'disabled' : ''}
                                    />
                                </div>
                                ` : ''}
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button
                                    onclick="handleSubmit();"
                                    class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-medium hover:shadow-lg transition-shadow disabled:opacity-50"
                                    ${loading ? 'disabled' : ''}
                                >
                                    ${loading ? 'Salvando...' : (editingId !== null ? 'Atualizar' : 'Adicionar')}
                                </button>
                                <button
                                    onclick="resetForm(); render();"
                                    class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors disabled:opacity-50"
                                    ${loading ? 'disabled' : ''}
                                >
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Items List -->
                    <div class="space-y-4">
                        ${loading && items.length === 0 ? `
                        <div class="bg-white rounded-xl shadow-md p-12 text-center">
                            <div class="text-6xl mb-4">‚è≥</div>
                            <p class="text-gray-500 text-lg">Carregando dados do Google Sheets...</p>
                        </div>
                        ` : filteredItems.length === 0 ? `
                        <div class="bg-white rounded-xl shadow-md p-12 text-center">
                            <div class="text-6xl mb-4">${searchTerm ? 'üîç' : 'üìö'}</div>
                            <p class="text-gray-500 text-lg">
                                ${searchTerm ? 'Nenhum resultado encontrado' : 'Nenhum item encontrado'}
                            </p>
                        </div>
                        ` : filteredItems.map((item, index) => `
                        <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow p-6">
                            <div class="flex items-start justify-between flex-wrap gap-4">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start gap-3 mb-3">
                                        <div class="text-3xl">${item.category === 'Livro' ? 'üìñ' : 'üì∫'}</div>
                                        <div class="flex-1">
                                            <h3 class="text-xl font-bold text-gray-800">${item.title}</h3>
                                            ${item.author ? `<p class="text-gray-600 mt-1">${item.author}</p>` : ''}
                                        </div>
                                    </div>

                                    <div class="flex flex-wrap gap-2 text-sm">
                                        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full font-medium">
                                            ${item.status}
                                        </span>
                                        ${item.rating ? `
                                        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full font-medium">
                                            ${item.rating}
                                        </span>
                                        ` : ''}
                                        ${item.date ? `<span class="text-gray-600">üìÖ ${formatDate(item.date)}</span>` : ''}
                                        ${item.pages ? `<span class="text-gray-600">${item.pages}</span>` : ''}
                                        ${item.country ? `<span class="text-gray-600">üåç ${item.country}</span>` : ''}
                                        ${item.avgTime ? `<span class="text-gray-600">‚è±Ô∏è ${formatTime(item.avgTime)}</span>` : ''}
                                    </div>
                                </div>

                                <div class="flex gap-2">
                                    <button
                                        onclick='handleEdit(${item.id})'
                                        class="px-4 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors disabled:opacity-50"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        Editar
                                    </button>
                                    <button
                                        onclick="handleDelete(${item.id})"
                                        class="px-4 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors disabled:opacity-50"
                                        ${loading ? 'disabled' : ''}
                                    >
                                        Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Atualiza o valor do input sem perder o foco
            const input = document.getElementById('searchInput');
            if (input && document.activeElement === input) {
                const cursorPos = input.selectionStart;
                input.value = searchInput;
                input.setSelectionRange(cursorPos, cursorPos);
            } else if (input) {
                input.addEventListener('input', function(e) {
                    searchInput = e.target.value;
                });
            }
        }

        loadData();
    </script>
</body>
</html>
